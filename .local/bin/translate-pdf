#!/bin/bash

[ -z "$1" ] && exit 1

PDF_FILE="$1"
TXT_FILE="${PDF_FILE::-4}_original.txt"
TRANSLATED_FILE="${PDF_FILE::-4}_translated.txt"
CHAR_THRESHOLD=100
CHAR_LIMIT=4800

[ -f "$TRANSLATED_FILE" ] && echo "translation already exist" && exit

# extract text from pdf
pdftotext "$PDF_FILE" "$TXT_FILE"

# remove all \n but keep \n\n
sed -i ':a;N;$!ba;s/\n\n/NEWLINENEWLINE/g' "$TXT_FILE"
sed -i ':a;N;$!ba;s/\n//g' "$TXT_FILE"
sed -i 's/NEWLINENEWLINE/\n\n/g' "$TXT_FILE"

touch "$TRANSLATED_FILE"
echo -n "begin to translate file .."
while read -r line ; do
    STRLENGTH=$(echo -n $line | wc -m)
    # if string length greater than CHAR_THRESHOLD translate, otherwise there are only headlines
    # or "Fig.1" that doesn't need to be translated but one request to deepl api seems to be
    # limited to 5000 chars
    if [ $STRLENGTH -ge $CHAR_THRESHOLD -o  $STRLENGTH -ge $CHAR_LIMIT ] ; then
        #echo "$line" | deepl translate -t 'DE' >> "$TRANSLATED_FILE"
        echo "$line" >> "$TRANSLATED_FILE"
        echo -n "."
        #sleep 1
    elif [ $STRLENGTH -ge 5 ] ; then
        echo "$line" >> "$TRANSLATED_FILE"
        echo -n "."
    elif [ "$line" = "\n" ] || [ "$line" = "" ]; then
        echo "$line" >> "$TRANSLATED_FILE"
    fi
done <<< "$(cat $TXT_FILE)"
echo " done"
