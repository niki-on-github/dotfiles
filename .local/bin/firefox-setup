#!/bin/bash
# Description: Script to deploy my firefox work environment
# TODO how to set firefox theme to dark? (user.js do not work)

FIREFOX_PROFILES_DIRECOTRY="$HOME/.mozilla/firefox"
FIREFOX_CACHE_DIRECTORY="$HOME/.cache/mozilla/firefox"
GHACKS_USERJS_DIRECTORY="$HOME/.config/firefox/ghacks-user.js"
OVERRIDE_FILES_NORMAL="$HOME/.config/firefox/my-overrides/normal"
OVERRIDE_FILES_HARDENED="$HOME/.config/firefox/my-overrides/hardened"

SETTINGS='{
"profiles": [{
        "name": "VPN",
        "addons": [ "bitwarden-password-manager", "canvasblocker", "darkreader", "decentraleyes", "floccus", "i-dont-care-about-cookies", "ublock-origin", "umatrix", "clearurls", "cookie-autodelete",  "multi-account-containers", "temporary-containers", "awesome-rss" ],
        "userJs": "hardened",
        "allowedSearchEngines": "(DuckDuckGo)",
        "defaultSearchEngine": "DuckDuckGo"
    }, {
        "name": "Banking",
        "addons": [ "bitwarden-password-manager", "darkreader", "floccus", "i-dont-care-about-cookies", "ublock-origin" ],
        "userJs": "normal",
        "allowedSearchEngines": "(DuckDuckGo)",
        "defaultSearchEngine": "DuckDuckGo"
    }, {
        "name": "Private",
        "addons": [ "bitwarden-password-manager", "canvasblocker", "darkreader", "decentraleyes", "floccus", "i-dont-care-about-cookies", "ublock-origin", "umatrix", "clearurls", "cookie-autodelete",  "multi-account-containers", "temporary-containers", "awesome-rss"],
        "userJs": "hardened",
        "allowedSearchEngines": "(DuckDuckGo)",
        "defaultSearchEngine": "DuckDuckGo"
    }
]}'


TMP_ADDON_DIRECTORY=$(mktemp -d)
_mozlz4=$HOME/.local/bin/mozlz4

if command -v firefox ; then
    _firefox=firefox
elif command -v firefox-bin ; then
    _firefox=firefox-bin
else
    echo "firefox is not installed!"
    exit 1
fi

error() {
    echo -e "\033[0;31mERROR:\033[0;31m $@"; exit 1
}

warning() {
    echo -e "\033[0;31mWARNING:\033[0m $@";
}

function clearCache() {
    profileName=$1; shift
    [ -z "$profileName" ] && error "profileName in clearCache() is empty"
    rm -rf "$FIREFOX_CACHE_DIRECTORY/*.$profileName"
}

function updateConfigs() {
    profileName=$1; shift
    [ -z "$profileName" ] && error "profileName in updateConfigs() is empty"
    rm -rf "$firefoxProfileCachePath"
    while pidof $_firefox >/dev/null ; do sleep 1 ; done
    $_firefox --headless -new-instance -P "$profileName" >/dev/null 2>&1 &
    fid=$!; sleep 6; kill $fid; wait $fid; sleep 3
    clearCache "$profileName"
}

function downloadAddon() {
    firefoxProfilePath=$1; shift
    downloadID=$1; shift
    [ -z "$firefoxProfilePath" ] && error "firefoxProfilePath in downloadAddon() is empty"
    [ -z "$downloadID" ] && error "downloadID in downloadAddon() is empty"

    [ -d "$firefoxProfilePath" ] || return
    mkdir -p "$firefoxProfilePath/extensions"

    if [ ! -d "$TMP_ADDON_DIRECTORY/$downloadID" ]; then
        echo "Download $downloadID to $TMP_ADDON_DIRECTORY/$downloadID"
        mkdir -p "$TMP_ADDON_DIRECTORY/$downloadID"
        wget --quiet -O "$TMP_ADDON_DIRECTORY/$downloadID/addon.xpi" \
            "https://addons.mozilla.org/firefox/downloads/latest/$downloadID/latest.xpi" 2>/dev/null
        unzip "$TMP_ADDON_DIRECTORY/$downloadID/addon.xpi" manifest.json -d "$TMP_ADDON_DIRECTORY/$downloadID" >/dev/null
    fi

    [ ! -f "$TMP_ADDON_DIRECTORY/$downloadID/manifest.json" ] && warning "FileNotFound: manifest.json" && return
    addonID=$(jq '.applications.gecko.id' "$TMP_ADDON_DIRECTORY/$downloadID/manifest.json")
    if [ -z "$addonID" ] || [ "$addonID" = "null" ] || [ "$addonID" = "{}" ] ; then
        # try .browser_specific_settings.gecko.id parser
        addonID=$(jq '.browser_specific_settings.gecko.id' "$TMP_ADDON_DIRECTORY/$downloadID/manifest.json")
    fi
    if [ -z "$addonID" ] || [ "$addonID" = "null" ] || [ "$addonID" = "{}" ] ; then
        # try mozilla-recommendation.json parser
        [ -f "$TMP_ADDON_DIRECTORY/$downloadID/mozilla-recommendation.json" ] || \
            unzip "$TMP_ADDON_DIRECTORY/$downloadID/addon.xpi" mozilla-recommendation.json -d "$TMP_ADDON_DIRECTORY/$downloadID" >/dev/null
        [ ! -f "$TMP_ADDON_DIRECTORY/$downloadID/mozilla-recommendation.json" ] && warning "FileNotFound: mozilla-recommendation.json" && return
        addonID=$(jq '.addon_id' "$TMP_ADDON_DIRECTORY/$downloadID/mozilla-recommendation.json")
    fi
    if [ -z "$addonID" ] || [ "$addonID" = "null" ] || [ "$addonID" = "{}" ] ; then
        warning "Addon ID entry not exist"
        return
    fi

    addonID=$(echo $addonID | sed 's/"//g')
    [ -f "$firefoxProfilePath/extensions/$addonID.xpi" ] && echo "Addon $downloadID:$addonID is already installed" && return
    echo "Install $downloadID ($addonID)" && cp -f "$TMP_ADDON_DIRECTORY/$downloadID/addon.xpi" "$firefoxProfilePath/extensions/$addonID.xpi"

    ! grep -q "$addonID" $firefoxProfilePath/myaddon.list >/dev/null 2>&1 && \
        echo "$addonID" >> $firefoxProfilePath/myaddon.list
}

function activateAddons() {
    firefoxProfilePath=$1; shift
    profileName=$1; shift
    [ -z "$firefoxProfilePath" ] && error "firefoxProfilePath in activateAddons() is empty"
    [ -z "$profileName" ] && error "profileName in activateAddons() is empty"

    [ -d "$firefoxProfilePath" ] || return
    [ -f "$firefoxProfilePath/myaddon.list" ] || return

    updateConfigs "$profileName"
    for addonID in $(cat $firefoxProfilePath/myaddon.list) ; do
        echo "Activate Addon $addonID"
        cat $firefoxProfilePath/extensions.json | \
            jq '(.addons | .[] | select(.id=="'$addonID'") | .active) = true' | \
            jq '(.addons | .[] | select(.id=="'$addonID'") | .userDisabled) = false' \
            > $firefoxProfilePath/extensions_new.json
        sleep 0.2 && mv -f "$firefoxProfilePath/extensions_new.json" "$firefoxProfilePath/extensions.json"
    done

    rm -f $firefoxProfilePath/addonStartup.json.lz4
    rm -f $firefoxProfilePath/myaddon.list
}

function createProfile() {
    profileName=$1; shift
    [ -z "$profileName" ] && error "profileName in createProfile() is empty"
    if ! grep -q "Name=$profileName" $FIREFOX_PROFILES_DIRECOTRY/profiles.ini ; then
        echo "Create Profile: $profileName"
        $_firefox -CreateProfile "$profileName"
        updateConfigs "$profileName"
    fi
}

function setupSearchengine() {
    firefoxProfilePath=$1; shift
    allowedSearchEngines=$1; shift
    defaultSearchEngine=$1; shift
    [ -z "$firefoxProfilePath" ] && error "firefoxProfilePath in setupSearchengine() is empty"
    [ -f $_mozlz4 ] || error "File not Found: $_mozlz4"
    [ -f $firefoxProfilePath/search.json.mozlz4 ] || return

    tmpSearchJsonFile=$(mktemp)
    $_mozlz4 -x $firefoxProfilePath/search.json.mozlz4 $tmpSearchJsonFile
    search_json=$(cat $tmpSearchJsonFile)
    changeNumbers=$(jq '.engines | .[] | ._name' $tmpSearchJsonFile | grep -Env "$allowedSearchEngines" | cut -d ':' -f 1)
    for num in $changeNumbers ; do
        search_json=$(echo "$search_json" | jq '.engines['$(($num-1))']._metaData.hidden = "true"')
    done

    if [ "$(echo "$search_json" | jq '.metaData')" = "{}" ]; then
        echo "Set default search engine to $defaultSearchEngine"
        echo "$search_json" | jq '. + {"metaData": {"current": "'$defaultSearchEngine'"}}' > $tmpSearchJsonFile
    else
        echo "Override default search engine with $defaultSearchEngine"
        echo "$search_json" | jq '. + {"metaData": {"current": "'$defaultSearchEngine'"}}' > $tmpSearchJsonFile
    fi
    $_mozlz4 -z $tmpSearchJsonFile $firefoxProfilePath/search.json.mozlz4
}

function updateNormalUserJs() {
    firefoxProfilePath=$1; shift
    [ -z "$firefoxProfilePath" ] && error "firefoxProfilePath in updateNormalUserJs() is empty"
    echo "Install UserJs"
    cp -rf $OVERRIDE_FILES_NORMAL/* $firefoxProfilePath/
}

function updateHardenUserJs() {
    firefoxProfilePath=$1; shift
    [ -z "$firefoxProfilePath" ] && error "firefoxProfilePath in updateHardenUserJs() is empty"
    echo "Install hardened UserJs"
    cp -rf $OVERRIDE_FILES_HARDENED/* $firefoxProfilePath/
    cd $GHACKS_USERJS_DIRECTORY && sh updater.sh -s -b -p "$firefoxProfilePath" && cd - >/dev/null
}


command -v jq >/dev/null || error "script require jq"

if ! echo "$SETTINGS" | jq >/dev/null; then
    error "Invalid config"
fi

read -p "Press the [Enter] key to continue. This will close all instances of Firefox"
pidof $_firefox >/dev/null && kill $(pidof $_firefox) && echo -n "close Firefox ." && sleep 1 && echo -n "." && sleep 1 && echo ". OK"

for profile in $(echo "${SETTINGS}" | jq '.profiles' | jq -r '.[] | @base64'); do
    _get() {
        echo ${profile} | base64 --decode | jq -r ${1}
    }
    profileName=$(_get '.name')
    addons=$(_get '.addons')
    userJs=$(_get '.userJs')
    allowedSearchEngines=$(_get '.allowedSearchEngines')
    defaultSearchEngine=$(_get '.defaultSearchEngine')

    echo -e "\nSetup Firefox profile $profileName"
    createProfile "$profileName"

    profilePath="$FIREFOX_PROFILES_DIRECOTRY/$(ls $FIREFOX_PROFILES_DIRECOTRY | grep "\.$profileName$")"
    echo "profilePath: $profilePath"

    setupSearchengine "$profilePath" "$allowedSearchEngines" "$defaultSearchEngine"

    for addon in $(echo "$addons" | jq -r '.[]'); do
        downloadAddon "$profilePath" "$addon"
    done

    if [ "$userJs" = "normal" ]; then
        updateNormalUserJs "$profilePath"
    else
        updateHardenUserJs "$profilePath"
    fi

    activateAddons "$profilePath" "$profileName"
    clearCache "$profileName"
done

echo -e "\nNOTE: To activate the new addons firefox has to be launched and closed once to show the new addons in the toolbar."
